# This is a basic workflow to build robot code.
name: CI
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch.
on:
  push:
    branches: [ main, feature/ntfyNotifications ]
  pull_request:
    branches: [ main ]
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-22.04
    container: wpilib/roborio-cross-ubuntu:2026-22.04-py314

    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
    
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add repository to git safe directories
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: The Magic Touch
        run: sed -i 's/\r$//' gradlew

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile and run tests on robot code
        run: bash ./gradlew build

      - name: Notify ntfy
        if: always()
        env:
          NTFY_URL: ${{ secrets.NTFY_URL }}
          STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.workflow }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SHA: ${{ github.sha }}
        run: |
          if [ "$STATUS" = "success" ]; then
            ICON="✅"
            PRIORITY="3"
            TAGS="white_check_mark,robot"
          elif [ "$STATUS" = "cancelled" ]; then
            ICON="⚠️"
            PRIORITY="3"
            TAGS="warning,robot"
          else
            ICON="❌"
            PRIORITY="5"
            TAGS="x,robot"
          fi
      
          SHORT_SHA="$(echo "$SHA" | cut -c1-7)"
      
          printf "Repo: %s\nBranch: %s\nActor: %s\nCommit: %s\n" \
            "$REPO" "$BRANCH" "$ACTOR" "$SHORT_SHA" \
          | curl -sS \
              -H "Title: ${ICON} ${WORKFLOW} (${STATUS})" \
              -H "Priority: ${PRIORITY}" \
              -H "Tags: ${TAGS}" \
              -H "Click: ${RUN_URL}" \
              --data-binary @- \
              "$NTFY_URL"

