# This is a basic workflow to build robot code.
name: CI
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch.
on:
  push:
    branches: [ main, feature/teamsNotification ]
  pull_request:
    branches: [ main ]
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-22.04
    container: wpilib/roborio-cross-ubuntu:2026-22.04-py314

    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
    
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add repository to git safe directories
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: The Magic Touch
        run: sed -i 's/\r$//' gradlew

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile and run tests on robot code
        run: bash ./gradlew build

      - name: Notify Teams (Adaptive Card)
        if: always()
        shell: bash
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.workflow }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [ "$STATUS" = "success" ]; then
            ICON="✅"
            TITLE="CI Succeeded"
          elif [ "$STATUS" = "cancelled" ]; then
            ICON="⚠️"
            TITLE="CI Cancelled"
          else
            ICON="❌"
            TITLE="CI Failed"
          fi

          SHORT_SHA="$(echo "$SHA" | cut -c1-7)"

          # Build payload safely (no heredoc)
          payload="$(python3 - <<'PY'
            import json, os
            icon = os.environ["ICON"]
            title = os.environ["TITLE"]
            workflow = os.environ["WORKFLOW"]
            repo = os.environ["REPO"]
            branch = os.environ["BRANCH"]
            actor = os.environ["ACTOR"]
            run_url = os.environ["RUN_URL"]
            commit_url = os.environ["COMMIT_URL"]
            short_sha = os.environ["SHORT_SHA"]

            data = {
              "type": "message",
              "attachments": [{
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "type": "AdaptiveCard",
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.4",
                  "body": [
                    {"type": "TextBlock", "text": f"{icon} {title}", "weight": "Bolder", "size": "Medium", "wrap": True},
                    {"type": "FactSet", "facts": [
                      {"title": "Workflow", "value": workflow},
                      {"title": "Repository", "value": repo},
                      {"title": "Branch", "value": branch},
                      {"title": "Actor", "value": actor},
                      {"title": "Commit", "value": short_sha},
                    ]}
                  ],
                  "actions": [
                    {"type": "Action.OpenUrl", "title": "View Run", "url": run_url},
                    {"type": "Action.OpenUrl", "title": "View Commit", "url": commit_url},
                  ]
                }
              }]
            }
            print(json.dumps(data))
            PY
            )"

                http_code=$(
                  ICON="$ICON" TITLE="$TITLE" SHORT_SHA="$SHORT_SHA" \
                  curl -sS -o response.txt -w "%{http_code}" \
                    -H "Content-Type: application/json" \
                    -d "$payload" \
                    "$TEAMS_WEBHOOK_URL"
                )

                echo "Teams webhook HTTP status: $http_code"
                echo "Response body:"
                cat response.txt || true

                if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
                  echo "❌ Teams webhook rejected the Adaptive Card"
                  exit 1
                fi
